<?php

/*
===========================================================

	프로젝트 이름 : 피리 웹프로그램 - 피리 맵 페이지 PLUS G5

	만든사람 : 피리 PIREE

	홈페이지 : http://www.piree.co.kr

	작성날짜 : 2016년 01월 26일 화요일 오후 12시 37분 - 날씨 한파 지나고 날씨가 좀 풀렸다.

	저 작 권 : Copyright ⓒ 2014-2016 투스포츠 (원병철) All right reserved
						 그누보드 외에 추가된 소스는~
						 만든사람의 허락없이 무단으로 사용할수 없습니다.
						 사용하고자 할 경우 만든사람의 허락을 받아야 합니다.
						 http://www.piree.co.kr 에 문의해 주세요.

===========================================================
 피리 맵 페이지 PLUS G5 > 지도 데이터 XML로 반환하기
===========================================================


*/


	#########################################################
  # 시작 => 선처리
  #########################################################

  //=======================================================
  // 그누보드5__기본_파일__첨부
	include_once('./_common.php');


  //=======================================================
  // 

  #########################################################
  # 끝 => 선처리
  #########################################################



  #########################################################
  # 시작 => 불러오는_방식__구분
  #########################################################

  //=======================================================
  // 게시판
  $bo_table = trim($_GET['bo_table']);
  $wr_id    = trim($_GET['wr_id']);
  $page     = trim($_GET['page']);


  //=======================================================
  // 지도_중앙_좌표
  $center_lat = trim($_GET['center_lat']);
  $center_lng = trim($_GET['center_lng']);


	//=======================================================
	// 위도_좌표
	$crd_lat_1 = trim($_GET['crd_lat_1']);
	$crd_lat_2 = trim($_GET['crd_lat_2']);


	//===================================================
	// 경도_좌표
	$crd_lng_1 = trim($_GET['crd_lng_1']);
	$crd_lng_2 = trim($_GET['crd_lng_2']);


	//===================================================
	// 카테고리
	$sca = trim($_GET['sca']);


	//===================================================
	// 시작 => 가운데_좌표_위도__검증
	IF ( !$center_lat )
	{
	    // alert("가운데 위도값이 제대로 전달되지 않았습니다.");
	    echo "가운데 위도값이 제대로 전달되지 않았습니다.";
	    exit;
	}


	//===================================================
	// 시작 => 가운데_좌표_경도__검증
	IF ( !$center_lng )
	{
	    // alert("가운데 경도값이 제대로 전달되지 않았습니다.");
	    echo "가운데 경도값이 제대로 전달되지 않았습니다.";
	    exit;
	}


	//===================================================
	// 시작 => 위도_좌표__검증
	IF ( !$crd_lat_1 || !$crd_lat_2 )
	{
	    // alert("위도 좌표값이 제대로 전달되지 않았습니다.");
	    echo "위도 좌표값이 제대로 전달되지 않았습니다.";
	    exit;
	}


	//===================================================
	// 시작 => Y_좌표__검증
	IF ( !$crd_lng_1 || !$crd_lng_2 )
	{
	    // alert("Y 좌표값이 제대로 전달되지 않았습니다.");
	    echo "Y 좌표값이 제대로 전달되지 않았습니다.";
	    exit;
	}


  //=======================================================
  // THUMBNAIL_라이브러리__파일_첨부
  include_once(G5_LIB_PATH.'/thumbnail.lib.php');

  #########################################################
  # 끝 => 불러오는_방식__구분
  #########################################################



  #########################################################
  # 시작 => 설정
  #########################################################

	//===================================================
	// 


  //=======================================================
  // 

  #########################################################
  # 시작 => 설정
  #########################################################



  #########################################################
  # 시작 => 상수__변수
  #########################################################

  //=======================================================
  // 결과__XML__문자열
  $xml_s = '';


  //=======================================================
  // 페이지__기본값
  IF ( !isset($page) || (isset($page) && $page == 0) || $page < 1 )
  {
      $page = 1;
  }

  #########################################################
  # 끝 => 상수__변수
  #########################################################



	#########################################################
	# 시작 => 피리_맵_페이지__설정_정보_파일__첨부
	#########################################################

	//=======================================================
	// 피리_메뉴__번호
	$piree_menu_n = 770033;


	//=======================================================
	// 기본_설정_첨부__여부
	// 0 - 안해
	// 1 - 하자
	$is_get__piree_config = 0;


	//=======================================================
	// 설정_정보__가져오기
	$is_get__p770033 = 1;


	//=======================================================
	// 설정_화면__여부
	$is_piree_program_config = 1;


	//=======================================================
	// 피리_맵_페이지__설정_정보_파일__경로
	include_once( get__sam_file($piree_menu_n, 'config', 'path') );

	#########################################################
	# 끝 => 피리_맵_페이지__설정_정보_파일__첨부
	#########################################################



  #########################################################
  # 시작 => 게시글_목록__불러오기
  #########################################################

  //=======================================================
  // 쿼리문__조건절
  $sql_search = ""; 


  //=======================================================
  // 전체_게시글
  $total_count = $board['bo_count_write'];


  //=======================================================
  // 시작 => 게시판_정보__없거나_다르면
  IF ( $bo_table != $board['bo_table'] )
  {

      //===================================================
      // 게시판 정보 불러오기
      $sql = "SELECT * FROM `". $g5['board_table'] ."` WHERE `bo_table` = '". $bo_table ."'";
      $board = sql_fetch($sql);

  }
  // 끝 => 게시판_정보__없거나_다르면
  //=======================================================


  //=======================================================
  // 정렬
  $sst = "`wr_num`, `wr_reply`";
  $sod = "";


  //=======================================================
  // 정렬_칼럼__정렬_순
  $sql_order = " ORDER BY {$sst} {$sod} ";


  //=======================================================
  // 게시판 테이블 전체이름
  $write_table = $g5['write_prefix'] . $bo_table;


  //=======================================================
  // 마커_번호
  $marker_n = 1;


	//=======================================================
	// 목록_순서__거꾸로
	$list_n = 0;


  //=======================================================
  // 게시글_수
  $list_t = 0;


  //=======================================================
  // 목록_의__페이지_번호
	$in_page_n = 0;


  //=======================================================
  // 게시글_목록
  $list_xml = array();


  //=======================================================
  // 쿼리문_조건절
  $sql_wh_s  = "(`wr_lng` BETWEEN ". $crd_lng_1 ." AND ". $crd_lng_2 .") AND ";
  $sql_wh_s .= "(`wr_lat` BETWEEN ". $crd_lat_1 ." AND ". $crd_lat_2 .")";


  //=======================================================
  // 시작 => 카테고리__있으면
  IF ( $sca )
  {

      //===================================================
      // 쿼리문_조건절
			$sql_wh_s .= " AND `ca_name` = '". $sca ."'";

  }
  // 끝 => 카테고리__있으면
  //=======================================================


  //=======================================================
  // 게시글_수__파악하기
  $sql = "SELECT COUNT(*) AS count FROM `". $write_table ."` WHERE ". $sql_wh_s;
  $res = sql_fetch($sql);
  $total_count = (int)$res['count'];


  //=======================================================
  // 시작 => 전체_목록__있으면
  IF ( $total_count > 0 )
  {

      //=======================================================
      // 시작 => DEVICE__구분
      IF(G5_IS_MOBILE)
      {
          $page_rows = $p770033__panel_article_row_n > 0 ? $p770033__panel_article_row_n : $board['bo_mobile_page_rows'];
          $list_page_rows = $board['bo_mobile_page_rows'];
      }
      ELSE
      {
          $page_rows = $p770033__panel_article_row_n > 0 ? $p770033__panel_article_row_n : $board['bo_page_rows'];
          $list_page_rows = $board['bo_page_rows'];
      }
      // 끝 => DEVICE__구분
      //=======================================================


			//===================================================
			// 가져올_마커수__게시글수
			$limit_n = $page_rows + $p770033__view_marker_small_t;


      //===================================================
      // 게시글 가져오기
      $sql  = "SELECT * FROM `". $write_table ."` ";
      $sql .= "WHERE ". $sql_wh_s ." ". $sql_order ." LIMIT ". $limit_n;
      $result = sql_query($sql);


      //===================================================
      // 시작 => 반복문
      WHILE ( $row = sql_fetch_array($result) )
      {

					//===============================================
					// XML_저장용
					$list_xml[$list_t] = $row;


					//===============================================
					// 마커_번호
					$list_xml[$list_t]['marker_n'] = $marker_n;


					//===============================================
					// 마커_번호__증가
					$marker_n++;


					//===============================================
					// 게시글_수__증가
					$list_t++;

      }
      // 끝 => 반복문
      //===================================================

  }
  // 끝 => 전체_목록__있으면
  //=======================================================

  #########################################################
  # 끝 => 게시글_목록__불러오기
  #########################################################



  #########################################################
  # 시작 => XML__출력하기
  #########################################################

  //=======================================================
  // 결과__XML__문자열
  /* $xml_s .= '<?xml version="1.0"?>'; */
  $xml_s .= '<?xml version="1.0" encoding="utf-8"?>';
  $xml_s .= '<markers>';


  //=======================================================
  // 시작 => 게시글_목록__있으면
  IF ( $list_t > 0 )
  {

			#####################################################
			# 시작 => 전체_건수
			#####################################################

      //===================================================
      // 결과__XML__문자열
			$xml_s .= '<marker r_d="tot" r_v="'. number_format($total_count) .'" />';

			#####################################################
			# 끝 => 전체_건수
			#####################################################



			#####################################################
			# 시작 => 패널_게시글_목록_이미지
			#####################################################

      //===================================================
      // 패널_게시글_목록_이미지__보여주기_여부
      $panel_image_view_n = 0;


      //===================================================
      // 시작 => 패널_게시글_목록_이미지__보여주기_이면
      IF ( $p770033__panel_image_view_n > 0 )
      {

					//===============================================
					// 시작 => 오른쪽_패널_목록_이미지__해상도__있으면
					IF ( $p770033__panel_image_size_w > 0 && $p770033__panel_image_size_h > 0 )
					{

							//===========================================
							// 패널_게시글_목록_이미지__보여주기_여부
							$panel_image_view_n = 1;

					}
					// 끝 => 오른쪽_패널_목록_이미지__해상도__있으면
					//===============================================

      }
      // 끝 => 패널_게시글_목록_이미지__보여주기_이면
      //===================================================

			#####################################################
			# 끝 => 패널_게시글_목록_이미지
			#####################################################



			#####################################################
			# 시작 => InfoWindow_이미지
			#####################################################

      //===================================================
      // InfoWindow_이미지__보여주기_여부
      $infowin_image_view_n = 0;


      //===================================================
      // 시작 => InfoWindow_이미지__보여주기_이면
      IF ( $p770033__infowin_image_view_n > 0 )
      {

					//===============================================
					// 시작 => 오른쪽_패널_목록_이미지__해상도__있으면
					IF ( $p770033__infowin_image_size_w > 0 && $p770033__infowin_image_size_h > 0 )
					{

							//===========================================
							// InfoWindow_이미지__보여주기_여부
							$infowin_image_view_n = 1;

					}
					// 끝 => 오른쪽_패널_목록_이미지__해상도__있으면
					//===============================================

      }
      // 끝 => InfoWindow_이미지__보여주기_이면
      //===================================================

			#####################################################
			# 끝 => InfoWindow_이미지
			#####################################################



			#####################################################
			# 시작 => 게시글_목록
			#####################################################

      //===================================================
      // 시작 => 반복문
      FOR ( $i=0; $i<count($list_xml); $i++ )
      {

					//===============================================
					// 목록_순서__거꾸로
					$list_n++;


					//===============================================
					// 목록_의__페이지_번호
					$in_page_n = ceil($list_n/$page_rows);


					//===============================================
					// 게시글_번호
					$in_wr_id = $list_xml[$i]['wr_id'];


					//===============================================
					// 게시글_제목
					$in_title = get_text($list_xml[$i]['wr_subject']);
					$in_title = str_replace('&', '&amp;', $in_title);


					//===============================================
					// 주소
					$in_address = trim($list_xml[$i]['wr_1']);
					$in_address = str_replace('&', '&amp;', $in_address);


					//===============================================
					// 내용
					$in_content = trim($list_xml[$i]['wr_2']);
					$in_content = str_replace('&', '&amp;', $in_content);


					//===============================================
					// 옵션
					$in_option = trim($list_xml[$i]['wr_6']);
					$in_option = str_replace('&', '&amp;', $in_option);

					//===============================================
					// 좌표_선택__여부
					$in_is_choice = $wr_id == $in_wr_id ? 1 : 0;


					//===============================================
					// 시작 => 페이지_번호__동일_여부
					IF ( $in_page_n == $page )
					{

							#############################################
							# 시작 => 동일_페이지__이면

							//===========================================
							// 마커_번호
							$in_marker_n = $list_xml[$i]['marker_n'];


							//===========================================
							// 패널에_이미지_URL
							$panel_img_url = "";


							//===========================================
							// InfoWindow_이미지_URL
							$infowin_limg_url = "";


							//===========================================
							// 시작 => 패널_게시글_목록_이미지__보여주기_이면
							IF ( $panel_image_view_n == 1 )
							{

									//=======================================
									// THUMBNAIL__알아내기
									$thumb = get_list_thumbnail($bo_table, $in_wr_id, $p770033__panel_image_size_w, $p770033__panel_image_size_h);


									//=======================================
									// 시작 => 이미지__있으면
									IF($thumb['src'])
									{
											$panel_img_url = $thumb['src'];
									}
									// 끝 => 이미지__있으면
									//=======================================

							}
							// 끝 => 패널_게시글_목록_이미지__보여주기_이면
							//===========================================


							//===========================================
							// 시작 => InfoWindow_이미지__보여주기_이면
							IF ( $infowin_image_view_n == 1 )
							{

									//=======================================
									// THUMBNAIL__알아내기
									$thumb = get_list_thumbnail($bo_table, $in_wr_id, $p770033__infowin_image_size_w, $p770033__infowin_image_size_h);


									//=======================================
									// 시작 => 이미지__있으면
									IF($thumb['src'])
									{
											$infowin_limg_url = $thumb['src'];
									}
									// 끝 => 이미지__있으면
									//=======================================

							}
							// 끝 => InfoWindow_이미지__보여주기_이면
							//===========================================


							//===========================================
							// 마커_ZINDEX__해당_페이지
							/*
							$marker_zindex_in = 1000-$in_marker_n;
							$marker_zindex_in = $i;
							*/
							$marker_zindex_in = 1000-$in_marker_n;

					}
					ELSE
					{

							#############################################
							# 시작 => 동일_페이지__아니면

							//===========================================
							// 마커_번호
							$in_marker_n = 0;


							//===========================================
							// 마커__번호
							/*
							$marker_zindex_in = $i;
							$marker_zindex_in = 1000-$i;
							*/
							$marker_zindex_in = $i;

					}
					// 끝 => 페이지_번호__동일_여부
					//===============================================


					//===============================================
					// 결과__XML__문자열
					/*
					$xml_s .= '<marker r_d="mak" mk_n="'. $in_marker_n .'" wr_id="'. $in_wr_id .'" subject="'. $in_title .'" address="'. get_text(stripslashes($in_address)) .'" lat="'. $list_xml[$i]['wr_lat'] .'" lng="'. $list_xml[$i]['wr_lng'] .'" zi="'. $marker_zindex_in .'" is_ch="'. $in_is_choice .'" />';
					$xml_s .= '<marker mk_n="'. $in_marker_n .'" wr_id="'. $in_wr_id .'" subject="'. $in_title .'" address="'. get_text(stripslashes($in_address)) .'" lat="'. $list_xml[$i]['wr_lat'] .'" lng="'. $list_xml[$i]['wr_lng'] .'" zi="'. $marker_zindex_in .'" is_ch="'. $in_is_choice .'" />';
					*/
					$xml_s .= '<marker r_d="mak" mk_n="'. $in_marker_n .'" wr_id="'. $in_wr_id .'" subject="'. $in_title .'" address="'. get_text(stripslashes($in_address)) .'" content="'. get_text(stripslashes($in_content)) .'" option="'. get_text(stripslashes($in_option)) .'" lat="'. $list_xml[$i]['wr_lat'] .'" lng="'. $list_xml[$i]['wr_lng'] .'" zi="'. $marker_zindex_in .'" is_ch="'. $in_is_choice .'" panel_img_url="'. $panel_img_url .'" infowin_limg_url="'. $infowin_limg_url .'" />';

      }
      // 끝 => 반복문
      //===================================================

			#####################################################
			# 끝 => 게시글_목록
			#####################################################



			#####################################################
			# 시작 => 페이지_분할
			#####################################################

      //===================================================
      // 시작 => 전체_게시글수가__SCALE_보다__많으면
      IF ( $total_count > $page_rows)
      {

					//===============================================
					// 지도_중앙_좌표
					$map_center	= "(". $center_lat .", ". $center_lng .")";


					//===============================================
					// 전체_페이지_계산
					$total_page	= ceil($total_count / $page_rows);


					//===============================================
					// 결과__XML__문자열
					$xml_s .= '<marker r_d="page" e_v_1="'. $map_center .'" e_v_2="'. $page .'" e_v_3="'. $total_page .'" />';

      }
      // 끝 => 전체_게시글수가__SCALE_보다__많으면
      //===================================================

/*

      //===================================================
      // 시작 => 전체_게시글수가__SCALE_보다__많으면
      IF ( $total_count > $page_rows)
      {

					//===============================================
					// 지도_중앙_좌표
					$map_center	= "(". $center_lat .", ". $center_lng .")";


					//===============================================
					// 전체_페이지_계산
					$total_page	= ceil($total_count / $page_rows);


					//===============================================
					// 결과__XML__문자열
					$xml_s .= '<marker r_d="page" e_v_1="'. $map_center .'" e_v_2="'. $page .'" e_v_3="'. $total_page .'" />';

      }
      // 끝 => 전체_게시글수가__SCALE_보다__많으면
      //===================================================

*/

			#####################################################
			# 끝 => 페이지_분할
			#####################################################

  }
  // 끝 => 게시글_목록__있으면
  //=======================================================


  //=======================================================
  // 결과__XML__문자열
  $xml_s .= '</markers>';


  //=======================================================
  // HEADER_출력
  // header("Content-type: text/xml");
  header("Content-Type: text/xml; charset=utf-8"); 


  //=======================================================
  // XML_출력
  echo $xml_s;

  #########################################################
  # 끝 => XML__출력하기
  #########################################################

?>